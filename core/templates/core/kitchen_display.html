{% extends "core/base.html" %}
{% load static %}

{% block title %}Kitchen Display{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ‘¨â€ğŸ³ Kitchen Display</h1>

  <div id="ticketBoard"
       class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    {% for ticket in tickets %}
      <div id="ticket-{{ ticket.id }}"
           class="bg-white shadow rounded-md p-4 border-t-4 border-yellow-500">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold text-lg text-gray-700">Order #{{ ticket.order_item.order.id|slice:":8" }}</h2>
          <span class="text-xs text-gray-500">{{ ticket.created_at|time:"H:i" }}</span>
        </div>
        <p class="text-gray-800 font-medium">{{ ticket.order_item.menu_item.name }}</p>
        <p class="text-gray-600 text-sm">Qty: {{ ticket.order_item.quantity }}</p>
      </div>
    {% empty %}
      <p class="col-span-full text-gray-500 italic text-center">No active tickets</p>
    {% endfor %}
  </div>
</div>

<script>
  const board = document.getElementById("ticketBoard");
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const socketUrl = `${protocol}://${window.location.host}/ws/kitchen_display/`;
  const socket = new WebSocket(socketUrl);

  socket.onopen = () => console.log("âœ… Connected to kitchen display WebSocket");

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log("ğŸ“¦ Kitchen update:", data);

    // Handle different actions: create, update, delete
    const action = data.action;
    const ticket = data.ticket;
    const elId = `ticket-${ticket.id}`;
    const existing = document.getElementById(elId);

    if (action === "delete" && existing) {
      existing.remove();
      return;
    }

    const html = `
      <div id="${elId}"
           class="bg-white shadow rounded-md p-4 border-t-4
                  ${ticket.status === "READY" ? "border-green-500" : "border-yellow-500"}">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold text-lg text-gray-700">Order #${ticket.order_id}</h2>
          <span class="text-xs text-gray-500">${ticket.time}</span>
        </div>
        <p class="text-gray-800 font-medium">${ticket.item_name}</p>
        <p class="text-gray-600 text-sm">Qty: ${ticket.quantity}</p>
      </div>`;
    if (existing) {
      existing.outerHTML = html;
    } else {
      board.insertAdjacentHTML("afterbegin", html);
    }
  };

  socket.onclose = () => {
    console.warn("ğŸ”Œ WebSocket disconnected â€” retrying in 5s");
    setTimeout(() => location.reload(), 5000);
  };
</script>
{% endblock %}