{% extends "core/base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'core/pos/style.css' %}" />

<div class="kds-screen">
  <h2>Kitchen Display Screen (KDS)</h2>
  <div id="orders-container" class="orders-grid"></div>
</div>

<script>
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/kitchen_display/`);

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const container = document.getElementById("orders-container");

    // --- 1ï¸âƒ£  Update status instead of cloning duplicate orders ---
    if (data.status && data.order_id) {
      const existing = document.getElementById("order-" + data.order_id);
      if (existing) {
        existing.className = "kds-card status-" + data.status;
        const statusEl = existing.querySelector(".status");
        if (statusEl) statusEl.textContent = data.status.toUpperCase();
      }
      return;
    }

    // --- 2ï¸âƒ£  Create new order card ---
    const card = document.createElement("div");
    card.className = "kds-card status-pending";
    card.id = "order-" + data.order_id;

    card.innerHTML = `
      <h3>Order #${data.order_id}</h3>
      <p><b>Table:</b> ${data.table}</p>
      <ul>
        ${(data.items || [])
          .map(i => `<li>${i.qty} Ã— ${i.name}</li>`)
          .join("")}
      </ul>
      <p><b>Total:</b> $${Number(data.total || 0).toFixed(2)}</p>
      <p class="status">PENDING</p>
      <div class="actions">
        <button onclick="updateStatus(${data.order_id}, 'cooking')">ğŸ”¥ Cooking</button>
        <button onclick="updateStatus(${data.order_id}, 'ready')">âœ… Ready</button>
        <button onclick="updateStatus(${data.order_id}, 'served')">ğŸ½ï¸ Served</button>
        <button onclick="updateStatus(${data.order_id}, 'paid')">ğŸ’° Paid</button>
      </div>
    `;

    container.prepend(card);
  };

  // --- 3ï¸âƒ£  Broadcast order status changes back to POS + Customer + Dashboard ---
  function updateStatus(order_id, status) {
    fetch("/pos/api/update-status/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order_id, status }),
    })
      .then(res => res.json())
      .then(resp => {
        if (!resp.success) alert("Error updating status");
      })
      .catch(err => console.error("Update failed:", err));
  }

  socket.onopen = () => console.log("ğŸŸ¢ Connected to KDS WebSocket");
  socket.onclose = () => console.warn("ğŸ”´ KDS WebSocket connection closed.");
</script>
{% endblock %}